<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontiSlam</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        body {
            width: 100vw;
            height: 100vh;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        #ar-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #0469f7;
            color: white;
        }
        button:hover {
            background-color: #0469f7;
        }
        model-viewer {
            width: 100%;
            height: 100%;
            margin: 0 auto;
            background-color: white;
        }
        /* .btn-active-audio{
            position: fixed;
            width: calc(100% - 40px);
            bottom: 0;
            left: calc(50% - 10px);
            z-index: 5;
            transform: translateX(-50%);
        } */
        .wrapper{
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .wrapper-model{
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 1;
        }
        .wrapper-button{
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 0 60px 0;
        }
        .loading{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }
        .hidden{
            display: none;
        }
    </style>
    </head>
    <body>
    <!-- Model Viewer with AR -->
     <div class="wrapper">
        <div class="wrapper-model">
            <div class="loading">loading...</div>
            <model-viewer id="modelViewer" 
                src="3d/1.glb"  
                ios-src="3d/1.usdz" 
                alt="A 3D model"
                ar ar-modes="scene-viewer quick-look"
                environment-image="neutral"
                camera-controls
                auto-rotate
                ar-scale="auto"
                touch-action="pan-y"
                disable-pan
                max-camera-orbit="auto 90deg auto"
                >
                <button slot="ar-button" class="hidden">
                    
                </button>
            </model-viewer>
        </div>
        <div class="wrapper-button">
            <div id="ar-buttons">
                <button id="store-btn">Магазин Konti</button>
                <button id="download-btn">Скачать Стикеры</button>
                <button id="share-btn">Поделиться Ссылкой</button>
                <button class="btn-active-audio">
                    Разместить Деда мороза
                </button>
            </div>
        </div>
     </div>
    
    <!-- Buttons to interact with AR -->


    <script>
        const modelViewer = document.getElementById('modelViewer');
        const audio = document.getElementById('placement-audio');

        // Button: Магазин Konti (Opens store page)
        document.getElementById('store-btn').addEventListener('click', () => {
            window.location.href = 'https://kontirus.ru'; // Replace with your store URL
        });

       

        // Button: Скачать Стикеры (Download stickers file)
        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = 'https://t.me/addstickers/KontiNewyear'; // Replace with your file URL
            //link.download = 'stickers.zip';
            link.click();
        });

        // Button: Поделиться Ссылкой (Share current page link)
        document.getElementById('share-btn').addEventListener('click', async () => {
            const shareData = {
                title: 'Check out this AR experience',
                text: 'View this AR model in 3D and AR!',
                url: window.location.href
            };
            try {
                await navigator.share(shareData);
            } catch (err) {
                alert('Sharing failed: ' + err.message);
            }
        });    


        modelViewer.addEventListener("model-visibility", event => {
            if (event.detail.visible) {
                document.querySelector('.loading').style.display = 'none'
            }
        });


        const btn = document.querySelector('.btn-active-audio')
        btn.onclick = async () => {
            try {
                btn.style.pointerEvents = "none";
                await startPlayAudio() 
                modelViewer.activateAR()
            } catch (error) {
                console.error(error)
            }
        }

        modelViewer.addEventListener("ar-status", event => {
            console.log(event)
        });


        const startPlayAudio = async () => {
            try {
                const response = await fetch('https://arplatov-6e62e-default-rtdb.firebaseio.com/baseNames.json')
                const {Names} = await response.json();
                
                const url = window.location.href
                const newurl = url.split("?")
                const idx = newurl[newurl.length-1]
                const soundname = Names[idx]?.sound

                const playSound = (soundname) =>{
                    let audioStart = new Audio(`/slam/firstPart.wav`);
                    let audioName = new Audio(`/slam/audio/speech/${soundname}`);
                    let audioFinaly = new Audio(`/slam/secondPart.wav`);
                
                    audioStart.onloadedmetadata = () => {
                        let durationStart = (audioStart.duration*1000) + 1000
                        audioStart.play(); 
                        setTimeout(() => {
                            let durationName = (audioName.duration*1000) + 200
                            audioName.play(); 
                            setTimeout(() => {
                                audioFinaly.play(); 
                                btn.style.pointerEvents = "auto";
                            }, durationName)  
                        }, durationStart)                 
                    }
                }

                playSound(soundname)
                
            } catch (error) {
                console.error('Error fetching Names:', error);
            }
        }


    </script>
</body>
</html>
