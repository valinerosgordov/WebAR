<!DOCTYPE html>
<html lang="en">
<head>
    <title>SLamAR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="main.css">
    
    <!-- Importing the Vaccine Regular font -->
    <style>
        .testSoundName {
            position: relative;
            display: flex;
            z-index: 99999;
        }
        @font-face {
            font-family: 'Vaccine Regular';
            src: url('fonts/Vaccine-Regular.ttf') format('truetype'); /* Update the path as needed */
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            font-family: 'Vaccine Regular', Arial, sans-serif; /* Set font for the body */
            overflow: hidden;
            background: none;
        }
        #content {
            position: fixed;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 10;
        }
        #content button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: 'Vaccine Regular', Arial, sans-serif; /* Font for buttons */
        }
        #content button:hover {
            background-color: #0056b3;
        }
        #instruction-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            display: none;
            text-align: center;
            font-family: 'Vaccine Regular', Arial, sans-serif; /* Font for instruction text */
        }
        #container {
            position: fixed;
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
    <div id="content">
        <button type="button" id="place-button" style="display:none;">Разместить</button>
        <button type="button" id="share-button">Поделиться</button>
        <a href="https://t.me/addstickers/KontiNewyear" target="_blank" id="download-stickers-link">
            <button type="button">СКАЧАТЬ СТИКЕРЫ</button>
        </a>
        <button type="button" id="shop-button">Перейти в магазин Konti</button>
        <button type="button" id="take-photo-button">Сделать фото</button>
    </div>
    <div id="container"></div>
    <div id="instruction-text">Наведите камеру на горизонтальную плоскость</div>



    <model-viewer
        id="ar-viewer"
        src="1.glb"
        alt="A 3D model of an object"
        ar
        ar-modes="scene-viewer quick-look"
        camera-controls
        style="display:none; width: 100%; height: 100%;"></model-viewer>

        <audio id="placement-sound" src="sound.wav" preload="auto"></audio>



    <script type="module">
        import * as THREE from './build/three.module.js';
        import { ARButton } from './jsm/webxr/ARButton.js';
        import { OrbitControls } from './jsm/controls/OrbitControls.js';
        import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
        import { RGBELoader } from './jsm/loaders/RGBELoader.js';

        let container, camera, scene, renderer, controller;
        let reticle, pmremGenerator, current_object, controls, isAR = false, envmap;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let animationMixer = null;
        const clock = new THREE.Clock();

        const placementSound = document.getElementById('placement-sound');

        init();
        animate();

        $("#place-button").click(function () {
            arPlace();
        });

        $("#share-button").click(function () {
            shareLink();
        });

        $("#shop-button").click(function () {
            window.open('https://your-shop-url.com', '_blank');
        });

        $("#take-photo-button").click(function () {
            takePhoto();
        });

        function shareLink() {
            const shareData = {
                title: 'Перейди по ссылке!',
                text: 'C новым годом',
                url: 'https://konti.digitalmarker.ru/slamshared'
            };

            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => console.log('Link shared successfully'))
                    .catch((error) => console.error('Error sharing link:', error));
            } else {
                alert('Your browser does not support the Web Share API.');
            }
        }
        let soundname= undefined;

        async function arPlace() {
            if (reticle.visible) {
                current_object.position.setFromMatrixPosition(reticle.matrix);
                current_object.visible = true;
                document.getElementById('instruction-text').style.display = 'none';
                console.log("Model placed at: ", current_object.position);
                // placementSound.play().catch(error => {
                //     console.error("Audio play failed: ", error);
                // });
                await fetchData()
            } else {
                console.log("Reticle is not visible. Cannot place the model.");
            }
        }

        function takePhoto() {
            renderer.toDataURL('image/png').then(function(dataUrl) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'photo.png';
                link.click();
                console.log("Photo taken and downloaded.");
            });
        }

        function loadModel() {
            new RGBELoader()
                .setDataType(THREE.UnsignedByteType)
                .setPath('textures/')
                .load('photo_studio_01_1k.hdr', function (texture) {
                    envmap = pmremGenerator.fromEquirectangular(texture).texture;
                    scene.environment = envmap;
                    texture.dispose();
                    pmremGenerator.dispose();
                    render();

                    const loader = new GLTFLoader().setPath('3d/');
                    loader.load("1.glb", function (glb) {
                        current_object = glb.scene;
                        current_object.visible = false;
                        scene.add(current_object);

                        if (glb.animations && glb.animations.length > 0) {
                            animationMixer = new THREE.AnimationMixer(current_object);
                            const action = animationMixer.clipAction(glb.animations[0]);
                            action.play();
                        }

                        const box = new THREE.Box3();
                        box.setFromObject(current_object);
                        box.getCenter(controls.target);
                        controls.update();
                        render();
                    }, undefined, function (error) {
                        console.error('An error happened during model loading:', error);
                    });
                });
        }

        function init() {
            container = document.createElement('div');
            document.getElementById("container").appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);
            camera.position.set(0, 1.6, 3);

            const directionalLight = new THREE.DirectionalLight(0xdddddd, 1);
            directionalLight.position.set(0, 0, 1).normalize();
            scene.add(directionalLight);

            const ambientLight = new THREE.AmbientLight(0x222222);
            scene.add(ambientLight);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            pmremGenerator = new THREE.PMREMGenerator(renderer);
            loadModel();

            controller = renderer.xr.getController(0);
            controller.addEventListener('selectstart', onSelectStart);
            controller.addEventListener('selectend', onSelectEnd);
            scene.add(controller);

            document.body.appendChild(ARButton.createButton(renderer));
            window.addEventListener('resize', onWindowResize);
        }

        function onSelectStart(event) {
            const controller = event.target;

            const intersections = getIntersections(controller);
            if (intersections.length > 0) {
                arPlace();
            }
        }

        function onSelectEnd(event) {}

        function getIntersections(controller) {
            const tempMatrix = new THREE.Matrix4();
            const line = new THREE.Line2(new THREE.Vector2(), new THREE.Vector2());

            const raycaster = new THREE.Raycaster();
            tempMatrix.identity().extractRotation(controller.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

            return raycaster.intersectObjects([current_object], false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            const delta = clock.getDelta();
            if (animationMixer) animationMixer.update(delta); // Update the animation mixer if it exists
            renderer.render(scene, camera);
        }

        async function fetchData() {
            try {
                const response = await fetch('https://arplatov-6e62e-default-rtdb.firebaseio.com/baseNames.json')
                const {Names} = await response.json();
                
                console.log(Names); 
                
                const url = window.location.href
                const newurl = url.split("?")
                const idx = newurl[newurl.length-1]
                soundname = Names[idx]?.sound

                console.log(soundname)

                playSound()
                
            } catch (error) {
                console.error('Error fetching Names:', error);
            }
        }

        const playSound = () =>{
            let audioStart = new Audio(`/slam/firstPart.wav`);
            let audioName = new Audio(`/slam/audio/speech/${soundname}`);
            let audioFinaly = new Audio(`/slam/secondPart.wav`);

            audioStart.onloadedmetadata = () => {
                let durationStart = (audioStart.duration*1000) + 500
                audioStart.play(); 
                setTimeout(() => {
                    let durationName = (audioName.duration*1000) + 200
                    audioName.play(); 
                    setTimeout(() => {
                        audioFinaly.play(); 
                    }, durationName)  
                }, durationStart)                 
            }
        }

    </script>
</body>
</html>
