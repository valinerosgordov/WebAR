<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontiSlam</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    </head>
    <body>
     <div class="wrapper">
        <div class="wrapper-model">
            <div class="loading">loading...</div>
            <model-viewer id="modelViewer" 
                src="3d/1.glb"  
                ios-src="3d/1.usdz" 
                alt="A 3D model"
                ar ar-modes="scene-viewer quick-look"
                environment-image="neutral"
                camera-controls
                ar-scale="auto"
                touch-action="pan-y"
                disable-pan
                max-camera-orbit="auto 90deg auto"
                 
                >
                <button slot="ar-button">
                    Разместить Деда мороза
                </button>
            </model-viewer>
        </div>
        <div class="wrapper-button">
            <div id="ar-buttons">
                <button id="store-btn">Магазин Konti</button>
                <button id="download-btn">Скачать Стикеры</button>
                <button id="share-btn">Поделиться Ссылкой</button>
                <button class="btn-active-audio">
                    Поздравить
                </button>
            </div>
        </div>
     </div>
    <script>
        const modelViewer = document.getElementById('modelViewer');

        const storeВtn = document.getElementById('store-btn')
        const downloadВtn = document.getElementById('download-btn')
        const shareВtn = document.getElementById('share-btn')

        //? Button: Магазин Konti (Opens store page)
        storeВtn.onclick = () => {
            window.location.href = 'https://kontirus.ru';
        }

        //? Скачать Стикеры (Download stickers file)
        downloadВtn.onclick = () => {
            const link = document.createElement('a');
            link.href = 'https://t.me/addstickers/KontiNewyear';
            link.click();
        }

        //? Поделиться Ссылкой (Share current page link)
        shareВtn.onclick = async () => {
            const shareData = {
                title: 'Check out this AR experience',
                text: 'View this AR model in 3D and AR!',
                url: window.location.href
            };
            try {
                await navigator.share(shareData);
            } catch (err) {
                alert('Sharing failed: ' + err.message);
            }
        } 

        //? Отображение загрузки
        modelViewer.addEventListener("model-visibility", event => {
            if (event.detail.visible) {
                document.querySelector('.loading').style.display = 'none'
            }
        });

        //? ar-status - не работает
        modelViewer.addEventListener("ar-status", event => {
            console.log(event)
        });


        //? Кнопка запускающие audio и AR
        const btn = document.querySelector('.btn-active-audio')
        btn.onclick = async () => {
            try {
                btn.style.pointerEvents = "none";
                await startPlayAudio() 
                // modelViewer.play()
                //modelViewer.activateAR()
            } catch (error) {
                console.error(error)
            }
        }

        //? Функция воспроизведения audio
        const startPlayAudio = async () => {
            try {
                const response = await fetch('https://arplatov-6e62e-default-rtdb.firebaseio.com/baseNames.json')
                const {Names} = await response.json();
                
                const url = window.location.href
                const newurl = url.split("?")
                const idx = newurl[newurl.length-1]
                const soundname = Names[idx]?.sound

                const playSound = (soundname) =>{
                    let audioStart = new Audio(`/slam/firstPart.wav`);
                    let audioName = new Audio(`/slam/audio/speech/${soundname}`);
                    let audioFinaly = new Audio(`/slam/secondPart.wav`);
                
                    audioStart.onloadedmetadata = () => {
                        let durationStart = (audioStart.duration*1000) + 1000
                        audioStart.play(); 
                        modelViewer.play()
                        setTimeout(() => {
                            let durationName = (audioName.duration*1000) + 200
                            audioName.play(); 
                            setTimeout(() => {
                                let durationFinaly = (audioFinaly.duration*1000) + 200
                                audioFinaly.play(); 
                                setTimeout(() => {
                                    btn.style.pointerEvents = "auto";
                                    modelViewer.pause()
                                }, durationFinaly) 
                            }, durationName)  
                        }, durationStart)                 
                    }
                }

                playSound(soundname)
                
            } catch (error) {
                console.error('Error fetching Names:', error);
            }
        }


    </script>
</body>
</html>
