<!DOCTYPE html>
<html lang="en">
<head>
<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
 
    ym(98476437, "init", {
         clickmap:true,
         trackLinks:true,
         accurateTrackBounce:true,
         webvisor:true
    });
 </script>
 <noscript><div><img src="https://mc.yandex.ru/watch/98476437" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
 <!-- /Yandex.Metrika counter -->
    <title>SLamAR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link type="text/css" rel="stylesheet" href="main.css">
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="./script/script.js"></script>
    <style>
    body {
    margin: 0;
    font-family: Arial, sans-serif;
    overflow: hidden;
    background: none;
}

/* Centered container for buttons at the top */
#content {
    position: fixed;
    top: 10px;
    width: 100%;
    display: flex;
    justify-content: center; /* Center buttons horizontally */
    flex-wrap: wrap; /* Allow buttons to wrap if needed */
    gap: 10px; /* Space between buttons */
    z-index: 10;
}

/* Shared button styling for top buttons */
#content button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s;
    white-space: nowrap;
    text-align: center;
}

#content button:hover {
    background-color: #0056b3;
}

/* Centered "Place" button at the bottom */
#place-button {
    position: fixed;
    bottom: 20px; /* Distance from the bottom of the screen */
    left: 50%;
    transform: translateX(-50%); /* Center horizontally */
    z-index: 10; /* Ensure it's above other elements */
    padding: 12px 24px; /* Adequate padding for better appearance */
    background-color: #007bff;
    color: white;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    white-space: nowrap;
    text-align: center;
    transition: background-color 0.3s;
}

#place-button:hover {
    background-color: #0056b3;
}

#screenshot-button {
    position: fixed;
    top: 10px; /* Positioned at the top right */
    right: 20px;
    z-index: 10;
    padding: 12px 24px;
    background-color: #007bff;
    color: white;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    white-space: nowrap;
    text-align: center;
    transition: background-color 0.3s;
}

#screenshot-button:hover {
    background-color: #0056b3;
}
#screenshot-button:hover {
    background-color: #0056b3;
}

/* Adjust widths automatically to fit text */
#place-button, #screenshot-button {
    width: auto;
}

    </style>
</head>
<body>
    <div id="content">
        <button type="button" id="place-button" style="display:none;">Разместить деда мороза</button>
        <button type="button" id="screenshot-button" style="display:none;">Сделать фото</button> <!-- Moved here -->
        <button type="button" id="share-button">Поделиться</button>
        <a href="https://t.me/addstickers/KontiNewyear" target="_blank" id="download-stickers-link">
            <button type="button">СКАЧАТЬ СТИКЕРЫ</button>
        </a>
        <button type="button" id="redirect-button">Магазин Konti</button>
    </div>
    <div id="container"></div>
    <div id="instruction-text">Наведите камеру на горизонтальную плоскость</div>

    <!-- Model Viewer for Cross-Platform AR Support -->
    <model-viewer
        id="ar-viewer"
        src="1.glb"
        alt="A 3D model of an object"
        ar
        ar-modes="scene-viewer quick-look"
        camera-controls
        style="display:none; width: 100%; height: 100%;"></model-viewer>

    <!-- Audio Element -->
    <audio id="placement-sound" src="sound.wav" preload="auto"></audio>

    <script type="module">
        import { startPlayAudio } from './script/script.js';
        import * as THREE from './build/three.module.js';
        import { ARButton } from './jsm/webxr/ARButton.js';
        import { OrbitControls } from './jsm/controls/OrbitControls.js';
        import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
        import { RGBELoader } from './jsm/loaders/RGBELoader.js';

        let container, camera, scene, renderer, controller;
        let reticle, pmremGenerator, current_object, controls, isAR = false, envmap;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let animationMixer = null; // Animation mixer
        const clock = new THREE.Clock(); // Clock for managing animation timing

        // Audio element for playing sound
        const placementSound = document.getElementById('placement-sound');

        init();
        animate();

        $("#place-button").click(function () {
            arPlace();
        });

        $("#share-button").click(function () {
            shareLink();
        });

        $("#redirect-button").click(function () {
            window.location.href = "https://kontirus.ru"; 
        });

        $("#screenshot-button").click(function () {
            takePicture();
        });

        function shareLink() {
            const shareData = {
                title: 'Перейди по ссылке!',
                text: 'C новым годом',
                url: 'https://konti.digitalmarker.ru/slamshared'
            };

            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => console.log('Link shared successfully'))
                    .catch((error) => console.error('Error sharing link:', error));
            } else {
                alert('Your browser does not support the Web Share API.');
            }
        }

        function arPlace() {
            if (reticle.visible) {
                current_object.position.setFromMatrixPosition(reticle.matrix);
                current_object.visible = true;
                document.getElementById('instruction-text').style.display = 'none'; // Hide the instruction text
                console.log("Model placed at: ", current_object.position);
                
                // Play the audio when the model is placed
                startPlayAudio(); // Play sound on model placement
            } else {
                console.log("Reticle is not visible. Cannot place the model.");
            }
        }

        function loadModel() {
            new RGBELoader()
                .setDataType(THREE.UnsignedByteType)
                .setPath('textures/')
                .load('photo_studio_01_1k.hdr', function (texture) {
                    envmap = pmremGenerator.fromEquirectangular(texture).texture;
                    scene.environment = envmap;
                    texture.dispose();
                    pmremGenerator.dispose();
                    render();

                    const loader = new GLTFLoader().setPath('3d/');
                    loader.load("1.glb", function (glb) {
                        current_object = glb.scene;
                        current_object.visible = false; // Initially hidden
                        scene.add(current_object);

                        // Create Animation Mixer and Play the Animation
                        if (glb.animations && glb.animations.length > 0) {
                            animationMixer = new THREE.AnimationMixer(current_object);
                            const action = animationMixer.clipAction(glb.animations[0]); // Play the first animation
                            action.play();
                        }

                        const box = new THREE.Box3();
                        box.setFromObject(current_object);
                        box.getCenter(controls.target); // Use getCenter instead of center

                        controls.update();
                        render();
                    }, undefined, function (error) {
                        console.error('An error happened during model loading:', error);
                    });
                });
        }

        function init() {
            container = document.createElement('div');
            document.getElementById("container").appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);
            camera.position.set(0, 1.6, 3);

            const directionalLight = new THREE.DirectionalLight(0xdddddd, 1);
            directionalLight.position.set(0, 0, 1).normalize();
            scene.add(directionalLight);

            const ambientLight = new THREE.AmbientLight(0x222222);
            scene.add(ambientLight);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();

            controls = new OrbitControls(camera, renderer.domElement);
            controls.addEventListener('change', render);
            controls.minDistance = 2;
            controls.maxDistance = 10;
            controls.target.set(0, 0, -0.2);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            let options = {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.getElementById('content') }
            };

            const arButton = ARButton.createButton(renderer, options);
            document.body.appendChild(arButton);

            arButton.addEventListener('click', () => {
                isAR = true;
                document.getElementById('instruction-text').style.display = 'block'; // Show the instruction text
                document.getElementById('ar-viewer').style.display = 'none'; // Hide model-viewer
                
                // Show the relevant buttons and hide others
                document.getElementById('place-button').style.display = 'block';
                document.getElementById('screenshot-button').style.display = 'block'; // Show screenshot button
                document.getElementById('share-button').style.display = 'none';
                document.getElementById('redirect-button').style.display = 'none';
                document.getElementById('download-stickers-link').style.display = 'none';
            });

            reticle = new THREE.Mesh(
                new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x000864 }) // Circle color
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            window.addEventListener('resize', onWindowResize, false);

            loadModel();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
            requestAnimationFrame(animate);
            controls.update();
        }

        function render(timestamp, frame) {
            // Update the mixer for playing animations
            if (animationMixer) {
                const delta = clock.getDelta(); // Get time difference between frames
                animationMixer.update(delta); // Update the mixer with the time delta
            }

            if (frame && isAR) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(function (referenceSpace) {
                        session.requestHitTestSource({ space: referenceSpace }).then(function (source) {
                            hitTestSource = source;
                        });
                    });

                    session.addEventListener('end', function () {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                        isAR = false;
                        reticle.visible = false;
                        document.getElementById("place-button").style.display = "none";
                        document.getElementById("screenshot-button").style.display = "none"; // Hide screenshot button
                        document.getElementById('instruction-text').style.display = 'none';
                        document.getElementById('ar-viewer').style.display = 'block'; // Show model-viewer again
                        
                        // Show other buttons again
                        document.getElementById('share-button').style.display = 'block';
                        document.getElementById('redirect-button').style.display = 'block';
                        document.getElementById('download-stickers-link').style.display = 'block';
                    });

                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        document.getElementById("place-button").style.display = "block";
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                        document.getElementById("place-button").style.display = "none";
                    }
                }
            }

            renderer.render(scene, camera);
        }

                function takePicture() {
            const picture = renderer.domElement.toDataURL('image/png'); // This still captures the canvas
            const link = document.createElement('a');
            link.href = picture;
            link.download = 'picture.png'; // Changed to 'picture.png'
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
