<!DOCTYPE html>
<html>
<head>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
  (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
  m[i].l=1*new Date();
  for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
  k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
  (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  ym(98476437, "init", {
       clickmap:true,
       trackLinks:true,
       accurateTrackBounce:true,
       webvisor:true
  });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/98476437" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KontiNewYear</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.aframe.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
  <style>
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(255, 0, 0, 0.8);
      color: rgba(255, 255, 255, 0.995);
      padding: 1em;
      border-radius: 5px;
      font-family: sans-serif;
    }
    #countdown {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4em;
      color: black;
      font-weight: bold;
      z-index: 101;
    }
    #guideText {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1em;
      color: white;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 101;
      font-family: sans-serif;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      text-align: center;
    }
    #whiteScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 100;
    }
    #popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 5px;
      display: none;
      z-index: 10;
      width: 300px;
    }
    #userInput {
      border: 2px solid #C0C0C0;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    #submitButton {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    h2 {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="errorMessage" class="error-message" style="display: none;"></div>
  <div id="countdown">0+</div>
  <div id="guideText">наведите камеру на логотип</div>
  <div id="whiteScreen"></div>
  <div id="popup">
    <h2>Введите ваше имя</h2>
    <input type="text" id="userInput" placeholder="Ваше имя">
    <a href="#" class="nextBtn">
      <button id="submitButton">Продолжить</button>
    </a>
  </div>

  <a-scene 
    mindar-image="imageTargetSrc: targets.mind; maxDetectionRate: 7" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false"
    style="display: none;">
    
    <a-assets>
      <video id="myVideo" preload="metadata" loop muted playsinline webkit-playsinline crossorigin="anonymous" type="video/mp4">
        <source src="konti.mp4" type="video/mp4">
        Ваш браузер не поддерживает видео.
      </video>
      <audio id="myAudio" preload="auto">
        <source src="voice.mp3" type="audio/mpeg">
      </audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane position="0 0 0" width="1.6" height="1.4" color="white" opacity="0.7" material="shader: flat; transparent: true;"></a-plane>
      <a-plane id="videoPlane" position="0 0 0.01" width="1.5" height="1.34" material="shader: flat; src: #myVideo; transparent: true;"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    // Error Handling
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
    }

    // Get the video element and other elements
    const video = document.getElementById('myVideo');
    const countdownEl = document.getElementById('countdown');
    const guideTextEl = document.getElementById('guideText');
    const sceneEl = document.querySelector('a-scene');
    const whiteScreenEl = document.getElementById('whiteScreen');
    const popupEl = document.getElementById('popup');
    const submitButton = document.getElementById('submitButton');
    const userInput = document.getElementById('userInput');
    const videoPlane = document.getElementById('videoPlane');

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    const checkVideoReady = () => {
      if (video.readyState >= 2) {
        video.play().catch(error => {
          console.error('Ошибка воспроизведения видео:', error);
        });
      } else {
        video.addEventListener('loadeddata', checkVideoReady);
      }
    };

    window.addEventListener('load', () => {
      if (isIOS) {
        document.body.addEventListener('click', () => {
          checkVideoReady();
        }, { once: true });
      } else {
        checkVideoReady();
      }
    });

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(() => {
        video.preload = "auto";
        video.load();

        setTimeout(() => {
          countdownEl.style.display = 'none';
          guideTextEl.style.opacity = 1;
          whiteScreenEl.style.display = 'none';
          sceneEl.style.display = 'block';
        }, 5000);
      })
      .catch((err) => {
        console.error("Error accessing camera:", err);
        showError("Не удалось получить доступ к камере.");
      });

let targetFound = false;

const addPlayTextOverlay = () => {
  const overlay = document.createElement('div');
  overlay.textContent = 'Нажмите для воспроизведения';
  overlay.className = 'video-overlay-hint';
  overlay.style.position = 'fixed';
  overlay.style.top = '50%';
  overlay.style.left = '50%';
  overlay.style.transform = 'translate(-50%, -50%)';
  overlay.style.color = 'white';
  overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  overlay.style.padding = '10px';
  overlay.style.borderRadius = '5px';
  overlay.style.textAlign = 'center';
  overlay.style.whiteSpace = 'nowrap';
  document.body.appendChild(overlay);
};

const removePlayTextOverlay = () => {
  const overlay = document.querySelector('.video-overlay-hint');
  if (overlay) {
    document.body.removeChild(overlay);
  }
};

const smoothTransform = (entity) => {
  const targetPosition = new THREE.Vector3(0, 0, 0);
  const fixedSize = new THREE.Vector3(1.5, 1.34, 0);
  entity.object3D.scale.lerp(fixedSize, 0.1); // Smoother scaling
  entity.object3D.position.lerp(targetPosition, 0.1); // Smoother position
  // You can optionally add quaternion smoothing if necessary
};

sceneEl.addEventListener('render-target-loaded', () => {
  let lastUpdate = Date.now();
  sceneEl.addEventListener('tick', () => {
    const now = Date.now();
    if (targetFound && now - lastUpdate > 5000) {
      smoothTransform(videoPlane);
      lastUpdate = now;
    }
  });
});

const targetEl = document.querySelector('a-entity[mindar-image-target]');
targetEl.addEventListener('targetFound', async () => {
  if (!targetFound) {
    console.log('Target Found!');
    targetFound = true;
    addPlayTextOverlay();

    const audio = document.getElementById('myAudio');

    const playMedia = async () => {
      try {
        video.setAttribute('autoplay', 'true');
        const audioPromise = audio.play();
        const videoPromise = video.play();
        await Promise.all([audioPromise, videoPromise]);
        guideTextEl.style.opacity = 0;
        removePlayTextOverlay();
      } catch (error) {
        console.error('Ошибка при воспроизведении медиа:', error);
        if (error.name === 'NotAllowedError') {
          showError("Пожалуйста, разрешите воспроизведение аудио.");
        }
      }
    };

    document.body.addEventListener('click', playMedia, { once: true });
    video.addEventListener('ended', handleMediaEnd);
    audio.addEventListener('ended', handleMediaEnd);
  } else {
    removePlayTextOverlay();
  }
});

const handleMediaEnd = () => {
  targetEl.parentNode.removeChild(targetEl);
  console.log("Аудио и видео воспроизведены полностью.");
  popupEl.style.display = 'block';
  video.removeEventListener('ended', handleMediaEnd);
  audio.removeEventListener('ended', handleMediaEnd);
};

sceneEl.addEventListener('mindar-image-track', (event) => {
  const isTracking = event.detail.tracked;
  if (isTracking && !targetFound) {
    video.currentTime = 0;
    targetFound = true;
  } else if (!isTracking && targetFound) {
    targetFound = false;
  }
});

submitButton.addEventListener('click', () => {
  const text = userInput.value.trim();
  if (!text) {
    showError("Пожалуйста, введите ваше имя!");
    return;
  }
  console.log("User entered:", text);
  popupEl.style.display = 'none';
  redirectWebSlam(text);
});

const redirectWebSlam = async (userName) => {
  const nextBtn = document.querySelector('.nextBtn');

  try {
    const response = await fetch('https://arplatov-6e62e-default-rtdb.firebaseio.com/baseNames.json');
    const { Names } = await response.json();
    const arrayUsers = Names;

    const idxName = arrayUsers.findIndex(i => i.name === userName);
    const url = `https://konti.digitalmarker.ru/slam?${idxName}`;
    nextBtn.href = url;
    window.location = url;

  } catch (error) {
    console.error('Error fetching Names:', error);
  }
};
</script>
</body>
</html>
